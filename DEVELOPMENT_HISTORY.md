# 開発履歴

本ドキュメントは、Zoom議事録自動生成システムの開発経緯と主要な意思決定を記録します。

## プロジェクト開始

### 初期要件(2024年)

ユーザーからの要望:
- TLDVで録画した面談の文字起こしを収集
- 文字起こし内容から構造的に議事録を作成
- プロンプトをカスタマイズ可能にする
- 採用面接の場合: 面接段階(一次/二次)を判断し、評価ポイント、候補者へのLINEメッセージを生成
- 通常会議の場合: 要約、アクションアイテムを抽出

### 技術選定の理由

#### フロントエンド
- **React 19**: 最新の機能(Suspense、自動バッチング)を活用
- **TypeScript**: 型安全性による開発効率向上とバグ削減
- **Tailwind CSS 4**: ユーティリティファーストで高速なUI開発
- **tRPC**: フロントエンドとバックエンドで型を共有し、API開発を効率化
- **shadcn/ui**: アクセシブルで再利用可能なコンポーネント

#### バックエンド
- **Node.js 22**: 最新のパフォーマンス改善とESM対応
- **Express**: 成熟したWebフレームワーク
- **Drizzle ORM**: 型安全でパフォーマンスの高いORM
- **MySQL/TiDB**: リレーショナルデータベースで複雑なクエリに対応

#### AI処理
- **Manus LLM API**: 統合済みのLLM APIで簡単にAI機能を実装
- **JSON Schema出力**: 構造化されたデータを確実に取得

## 開発フェーズ

### Phase 1: 要件調査とTLDV API調査

**実施内容**:
- TLDV APIドキュメントの調査
- Transcript取得方法の確認
- データベーススキーマの初期設計

**結果**:
- TLDV APIが利用できないことが判明
- **方針変更**: TLDVからZoom APIへ切り替え

### Phase 2: Zoom API調査と要件再定義

**実施内容**:
- Zoom APIドキュメントの詳細調査
- Webhook仕様の確認
- Server-to-Server OAuth認証方式の選定

**主要な発見**:
- Zoom APIは`recording.completed`イベントでWebhook通知を提供
- 録画ファイルと文字起こしは`download_token`(24時間有効)でダウンロード可能
- VTT形式の文字起こしが利用可能

**技術的決定**:
- Server-to-Server OAuth方式を採用(ユーザー認証不要)
- Webhook署名検証(HMAC SHA256)でセキュリティを確保
- VTT形式をパースしてプレーンテキストに変換

### Phase 3: データベース設計

**テーブル設計**:
1. **users**: Manus OAuth連携、ロールベースアクセス制御
2. **meetings**: Zoom会議情報、処理ステータス、会議種類
3. **transcripts**: 文字起こしデータ(プレーンテキスト + VTT)
4. **minutes**: 生成された議事録
5. **actionItems**: アクションアイテム管理
6. **promptTemplates**: カスタマイズ可能なプロンプト

**設計上の工夫**:
- `meetingType`をenumで定義し、型安全性を確保
- JSON型フィールド(`keyPoints`, `decisions`, `evaluationPoints`)で柔軟なデータ構造
- `customPrompt`フィールドで使用したプロンプトを記録

### Phase 4: Zoom連携機能の実装

**実装内容**:
1. **Zoom OAuth認証** (`server/_core/zoomAuth.ts`)
   - アクセストークンの自動取得
   - トークンキャッシュ機能(有効期限管理)
   - Zoom API呼び出しヘルパー

2. **Zoom Webhook検証** (`server/_core/zoomWebhook.ts`)
   - HMAC SHA256署名検証
   - タイムスタンプ検証(リプレイ攻撃対策)
   - 型定義(TypeScript)

3. **Zoom録画サービス** (`server/zoomService.ts`)
   - 録画ファイルダウンロード
   - VTT文字起こし取得
   - VTTパーサー(タイムスタンプ除去)

4. **Webhookハンドラー** (`server/webhookHandler.ts`)
   - `recording.completed`イベント処理
   - 会議情報のDB保存
   - 文字起こし自動ダウンロード
   - エラーハンドリング

**技術的課題と解決策**:
- **課題**: VTT形式にタイムスタンプが含まれる
- **解決**: 正規表現でタイムスタンプを除去し、プレーンテキストに変換

### Phase 5: AI処理機能の実装

**実装内容**:
1. **会議種類判定** (`classifyMeetingType`)
   - 文字起こしテキストから会議種類を判定
   - 採用面接の場合はステージも判定
   - 判定信頼度と理由を取得

2. **採用面接用議事録生成** (`generateInterviewMinutes`)
   - 候補者名、要約、評価ポイント
   - 推薦度と理由
   - LINEメッセージ自動生成

3. **通常会議用議事録生成** (`generateRegularMinutes`)
   - 要約、主要ポイント、決定事項
   - アクションアイテム抽出

4. **自動処理統合** (`processTranscriptWithAI`)
   - Webhook受信後の自動AI処理
   - ステータス管理(pending → processing → completed/failed)

**AI処理の工夫**:
- JSON Schema出力で構造化されたデータを確実に取得
- カスタムプロンプト対応で柔軟性を確保
- エラー時は`processingError`フィールドに記録

### Phase 6: 会議種類の拡張

**背景**:
ユーザーからのフィードバック:
> 「採用面接と通常会議だけでなく、取引先との打ち合わせなど、いろんな会議があるので対応してほしい」

**実装内容**:
会議種類を2種類から7種類に拡張:
1. **interview** - 採用面接
2. **internal_meeting** - 社内会議
3. **client_meeting** - 取引先との打ち合わせ
4. **one_on_one** - 1on1ミーティング
5. **training** - 研修・トレーニング
6. **presentation** - プレゼン・説明会
7. **other** - その他

**各タイプ専用の議事録フォーマット**:
- **取引先打ち合わせ**: フォローアップメール案を自動生成
- **社内会議**: 決定事項とアクションアイテムを重点的に抽出
- **その他**: 汎用的な議事録フォーマット

**データベーススキーマ更新**:
- `meetingType`のenumを拡張
- `meetingSubType`フィールドを追加(より具体的な分類)

**技術的課題と解決策**:
- **課題**: 既存のマイグレーションとの競合
- **解決**: 全テーブルを削除して再作成(開発初期段階のため)

### Phase 7: tRPC API実装

**実装内容**:
1. **meetings router**
   - `list`: 会議一覧取得
   - `getById`: 会議詳細取得
   - `reprocess`: 手動再処理

2. **prompts router**
   - `list`: プロンプトテンプレート一覧
   - `create`: 新規作成
   - `update`: 更新
   - `delete`: 削除

**設計上の工夫**:
- `protectedProcedure`で認証必須のエンドポイントを保護
- Zodスキーマで入力バリデーション
- Superjsonで`Date`型を自動シリアライズ

### Phase 8: ドキュメント整備

**作成したドキュメント**:
1. **README.md**: プロジェクト概要、セットアップ手順、API仕様
2. **TECH_STACK.md**: 技術スタック詳細
3. **workflow.puml**: システムワークフロー図(PlantUML)
4. **workflow.png**: ワークフロー図(PNG)
5. **todo.md**: 開発進捗管理

**ドキュメント作成の方針**:
- 情報密度を高く、抜け漏れなく記載
- 技術的な詳細も含める
- トラブルシューティングガイドを充実

## 主要な技術的決定

### 1. TLDVからZoom APIへの切り替え

**理由**:
- TLDV APIが利用できなかった
- Zoom APIは公式で安定している
- Webhookによる自動処理が可能

**影響**:
- データベーススキーマの変更
- API連携コードの全面書き換え

### 2. Server-to-Server OAuth方式の採用

**理由**:
- ユーザー認証が不要
- トークン管理が簡単
- Webhook受信に適している

**代替案**:
- OAuth 2.0(ユーザー認証): 複雑で不要

### 3. tRPCの採用

**理由**:
- フロントエンドとバックエンドで型を共有
- RESTful APIよりも開発効率が高い
- 自動補完が効く

**代替案**:
- RESTful API: 型安全性が低い
- GraphQL: オーバースペック

### 4. JSON Schema出力の採用

**理由**:
- 構造化されたデータを確実に取得
- AIの出力が安定する
- パースエラーが減る

**代替案**:
- プレーンテキスト出力: パースが不安定

### 5. 会議種類の拡張(2種類 → 7種類)

**理由**:
- ユーザーからのフィードバック
- 実際の業務では多様な会議がある
- 各タイプに最適な議事録フォーマットを提供

**影響**:
- AI判定ロジックの複雑化
- データベーススキーマの変更
- 各タイプ専用の議事録生成関数

## 未実装機能と今後の計画

### 短期的な計画

1. **フロントエンドUI実装**
   - 会議一覧ページ
   - 会議詳細ページ
   - 議事録表示UI
   - プロンプト編集UI

2. **テストコード実装**
   - ユニットテスト(Vitest)
   - 統合テスト
   - E2Eテスト

### 中期的な計画

1. **通知機能**
   - メール通知
   - Slack通知
   - Webhook通知

2. **レポート機能**
   - 月次サマリー
   - 会議統計
   - ダッシュボード

### 長期的な計画

1. **他の会議ツール対応**
   - Google Meet
   - Microsoft Teams

2. **多言語対応**
   - 文字起こし言語の自動検出
   - 多言語議事録生成

3. **API公開**
   - 外部システムとの連携
   - Webhook配信

## 学んだこと

### 技術的な学び

1. **Zoom APIの仕様**
   - Webhookの署名検証が必須
   - download_tokenの有効期限(24時間)に注意
   - VTT形式の文字起こしはパースが必要

2. **AI処理の安定性**
   - JSON Schema出力で構造化されたデータを取得
   - プロンプトの品質が結果に大きく影響
   - エラーハンドリングが重要

3. **tRPCの利便性**
   - 型安全性が開発効率を大幅に向上
   - フロントエンドとバックエンドの連携が簡単
   - 自動補完が非常に便利

### プロジェクト管理の学び

1. **要件の柔軟な変更**
   - TLDVからZoomへの切り替え
   - 会議種類の拡張

2. **ドキュメントの重要性**
   - 情報密度の高いドキュメントが後の開発を助ける
   - トラブルシューティングガイドは必須

3. **段階的な実装**
   - まずバックエンドを完成させる
   - フロントエンドは後から実装

## まとめ

本プロジェクトは、Zoom APIとAIを組み合わせて、会議の議事録を自動生成するシステムです。当初はTLDV APIを使用する予定でしたが、利用できなかったためZoom APIに切り替えました。会議種類も当初の2種類から7種類に拡張し、各タイプに最適な議事録フォーマットを提供できるようになりました。

バックエンド機能は完成しており、Zoom Webhook受信、文字起こし取得、AI処理、議事録生成、プロンプトカスタマイズなど、すべての主要機能が実装されています。今後はフロントエンドUIの実装とテストコードの追加を進めていく予定です。
